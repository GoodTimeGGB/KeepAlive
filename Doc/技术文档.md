这是一份专为**微信原生开发（Native + 本地存储）**编写的技术规格说明书。你可以将这份文档直接提供给开发人员，或者作为自己在微信开发者工具中编写代码的蓝本。

---

# 🛠️ 技术规格说明书 (Technical Spec)
**项目名称**：KeepAlive (码上回血)
**项目类型**：微信小程序 (WeChat Mini Program)
**项目版本**：V1.0 演示版本
**开发模式**：原生开发 (WXML/WXSS/JS) + 本地存储 (Storage API)

---

## 1. 技术架构 (Architecture)

为了实现轻量化和演示目的，本项目采用**本地存储**架构。

*   **前端框架**：微信小程序原生框架 (Native)
*   **数据存储**：**微信本地存储 (wx.setStorageSync)**
    *   *优势*：无需服务器配置，适合演示和快速开发，未来可扩展为云开发。
*   **UI 方案**：
    *   基础样式：CSS3 Flexbox / Grid 布局
    *   设计风格：自定义 CSS 变量实现 Nord (护眼) 配色体系
*   **提醒机制**：
    *   方案 A：**订阅消息 (Subscribe Message)** —— 用于服务端定时推送。
    *   方案 B：**手机日历 (Phone Calendar)** —— 用于本地强提醒（作为补充）。

---

## 2. 目录结构设计 (Project Structure)

```text
miniprogram/
├── miniprogram/
│   ├── components/          // 公共组件
│   │   ├── progress-ring/   // 环形进度条组件
│   │   └── timer-modal/     // 运动倒计时弹窗
│   ├── images/              // 图片资源
│   ├── pages/
│   │   ├── index/           // [首页] 仪表盘
│   │   ├── settings/        // [设置] 登录与提醒配置
│   │   └── stats/           // [统计页] 数据统计
│   ├── utils/               // 工具类目录
│   │   ├── storage.js       // 本地存储管理
│   │   └── date.js          // 日期处理工具
│   ├── app.js               // 全局逻辑
│   ├── app.json             // 全局配置
│   └── app.wxss             // 全局样式 (定义CSS变量)
└── project.config.json
```

---

## 3. UI 样式规范 (Global Styles)

在 `app.wxss` 中定义全局 CSS 变量，确保“护眼舒适”风格的统一。

```css
/* app.wxss */
page {
  /* Nord Color Palette - 护眼色系 */
  --bg-color: #ECEFF4;        /* 浅灰白背景 */
  --card-bg: #FFFFFF;         /* 卡片背景 */
  --text-main: #2E3440;       /* 深灰文字 */
  --text-sub: #4C566A;        /* 次级文字 */
  --primary: #88C0D0;         /* 冰河蓝 (主色) */
  --accent: #A3BE8C;          /* 抹茶绿 (成功/强调) */
  --warning: #EBCB8B;         /* 柔和黄 (提醒) */
  
  /* Layout */
  --radius-lg: 24rpx;         /* 大圆角 */
  --radius-md: 16rpx;         /* 中圆角 */
  --shadow: 0 4rpx 12rpx rgba(0, 0, 0, 0.05);
}

/* 暗黑模式适配 (Media Query) */
@media (prefers-color-scheme: dark) {
  page {
    --bg-color: #2E3440;
    --card-bg: #3B4252;
    --text-main: #ECEFF4;
    --text-sub: #D8DEE9;
  }
}
```

---

## 4. 本地存储结构设计 (Storage Schema)

在本地存储中使用以下键名存储数据。

### 4.1 本地存储键：`ka_user` (用户信息与设置)

| 字段名 | 类型 | 描述 | 示例 |
| :--- | :--- | :--- | :--- |
| `profile` | Object | 用户昵称头像 | `{ nickName: "CodeMaster", avatar: "..." }` |
| `settings` | Object | 设置项 | 见下文 |

`settings` 结构：
```json
{
  "dailyTarget": 8,            // 目标杯数
  "reminderEnabled": true,     // 提醒开关
  "workTime": 60,              // 久坐提醒间隔(分钟)
  "reminderTimeRange": ["09:00", "19:00"] // 提醒时间段
}
```

### 4.2 本地存储键：`ka_logs` (行为日志)

| 字段名 | 类型 | 描述 | 示例 |
| :--- | :--- | :--- | :--- |
| `dateStr` | String | 日期索引 (YYYY-MM-DD) | "2023-10-24" |
| `waterIntake` | Number | 已喝杯数 | 5 |
| `exercises` | Number | 运动次数 | 2 |
| `lastUpdated` | Time Time 最后更新时间 | new Date() |

---

## 5. 核心功能实现逻辑

### 5.1 首页 (Dashboard) - `pages/index`

**逻辑流程**：
1.  **OnShow**: 获取 `new Date()` 格式化为 `YYYY-MM-DD`。从本地存储读取 `ka_logs`，过滤当日数据。
2.  **渲染**:
    *   如果无记录，显示 0/8。
    *   如果有记录，计算百分比，CSS 动态设置环形进度条 (`conic-gradient`)。
3.  **交互**:
    *   `onTapDrink()`:
        *   前端 `data.water++` (即时反馈)。
        *   调用工具函数 `Storage.updateLog({ type: 'water' })` 保存到本地。
        *   `wx.vibrateShort()` (震动反馈)。
    *   `onTapExercise()`:
        *   显示全屏 Modal。
        *   启动 `setInterval` 倒计时 60s。
        *   倒计时结束 -> 播放音效 -> 调用 `Storage.updateLog({ type: 'exercise' })` 保存到本地。

### 5.2 设置与登录 - `pages/settings`

**逻辑流程**：
1.  **登录**:
    *   使用 `<button open-type="chooseAvatar">` 和 `<input type="nickname">`。
    *   获取到资料后，调用 `Storage.saveUser()` 保存到本地存储。
2.  **微信提醒配置 (关键难点)**:
    *   **步骤 1**: 用户点击"开启提醒" Switch。
    *   **步骤 2 (推荐)**: 引导用户添加**日历提醒**。
        *   调用 `wx.addPhoneCalendar`。
        *   参数：`title: '该喝水了'`, `startTime: '今日10:00'`, `repeat: 'daily'`。
        *   *注：日历提醒是客户端功能，无需后端支持。*

---

## 6. 本地存储工具函数定义 (API)

### 💾 工具函数: `Storage.updateLog`
*   **作用**：更新喝水或运动数据，如果当日记录不存在则创建。
*   **存储位置**：本地存储键 `ka_logs`
*   **输入**：`{ type: 'water' | 'exercise', date: '2023-10-24' }`
*   **代码逻辑 (JavaScript)**：
    ```javascript
    const logs = wx.getStorageSync('ka_logs') || []
    const today = new Date().toISOString().split('T')[0]
    const todayLog = logs.find(log => log.dateStr === today)

    if (todayLog) {
      if (type === 'water') todayLog.waterIntake++
      if (type === 'exercise') todayLog.exercises++
      todayLog.lastUpdated = new Date()
    } else {
      // 创建新记录
      logs.push({
        dateStr: today,
        waterIntake: type === 'water' ? 1 : 0,
        exercises: type === 'exercise' ? 1 : 0,
        lastUpdated: new Date()
      })
 })
    wx.setStorageSync('ka_logs', logs)
    ```

### 📅 未来可扩展：云函数 `sendDailyReminder`
*   **配置**：在 `config.json` 中配置 `triggers` (Cron 表达式)。
*   **频率**：`0 0 10,14,16 * * * *` (每天10点, 14点, 16点触发)。
*   **逻辑**：
    1.  查询云端数据库用户集合。
    2.  循环调用 `cloud.openapi.subscribeMessage.send`。
    3.  *注*：V1.0 演示版本暂不实现云开发，功能可扩展为云端定时任务。

---

## 7. 提醒功能说明 (演示版本)

在微信生态中做提醒，V1.0 演示版本采用以下策略：

1.  **强提醒 (日历 - 推荐)**：在设置页做一个按钮 "一键导入今日喝水计划到日历"。
    *   调用 `wx.addPhoneCalendar`，直接在系统日历写入 4-5 个时间点。
2.  **App内提醒 (演示方案)**：
    *   在用户打开小程序时，检查距离上次运动时间，超过设定时间则显示提醒弹窗。

```javascript
// V1.0 演示版本实现
// 检查上次运动时间，如果超过 60 分钟，显示提示
const lastExercise = getLastExerciseTime()
const now = new Date().getTime()
if (now - lastExercise > 60 * 60 * 1000) {
  showReminderModal()
}
```

按照这份文档开发，你的“码上回血”小程序将拥有扎实的代码结构和流畅的用户体验。Happy Coding! 🚀