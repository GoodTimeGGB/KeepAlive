这份文档是专门为 **Opencode (微信小程序开发)** 或 **AI 辅助编程**（如 Cursor, Github Copilot, 微信开发者工具 AI 助手）准备的。

它采用了**技术规范（Technical Spec）**的格式，详细定义了数据结构、API 接口和逻辑流程，你可以直接把它喂给 AI，或者作为开发大纲。

---

# 🚀 项目需求规格书 (PRD) - 程序员加油站 (KeepAlive)

## 1. 项目概况 (Overview)
*   **项目名称**：程序员加油站 (KeepAlive)
*   **平台**：微信小程序 (WeChat Mini Program)
*   **版本**：V1.0 演示版本
*   **核心理念**：护眼、舒适、极简、养生。
*   **数据存储**：本地存储 (未来可扩展为云开发)
*   **技术栈推荐**：
    *   **前端**：WXML, WXSS, JavaScript/TypeScript。
    *   **后端/数据库**：**本地存储 (wx.setStorageSync)** —— *理由：无需服务器配置，适合演示开发，未来可扩展为云开发。*
    *   **UI 组件库**：Vant Weapp 或 TDesign (推荐 TDesign，腾讯官方出品，风格更现代护眼)。

---

## 2. 视觉与 UI 规范 (Design System)
*   **整体风格**：Nord (北欧冷淡风) / 舒适护眼模式。
*   **配色方案**：
    *   背景色 (Background): `#F0F2F5` (柔和灰白) 或 `#2E3440` (暗夜模式深灰)。
    *   主色调 (Primary): `#88C0D0` (冰河蓝 - 用于进度条、图标)。
    *   强调色 (Accent): `#A3BE8C` (抹茶绿 - 用于完成、确认按钮)。
    *   文字色 (Text): `#4C566A` (深灰 - 避免纯黑刺眼)。
*   **字体**：PingFang SC (iOS), Source Han Sans (Android)。

---

## 3. 本地存储结构设计 (Storage Schema)
在本地存储中使用以下键名存储数据。

### 3.1 本地存储键：`ka_user` (用户信息与设置)
用于存储用户设置和基本信息。
```json
{
  "userInfo": {
    "nickName": "微信昵称",
    "avatarUrl": "头像地址"
  },
  "settings": {
    "dailyTarget": 8,           // number, 每日目标杯数
    "remindSwitch": true,       // boolean, 提醒总开关
    "remindStartTime": "09:00", // string, 开始提醒时间
    "remindEndTime": "18:00",   // string, 结束提醒时间
    "remindInterval": 60        // number, 提醒间隔(分钟)
  },
  "lastLoginTime": "Date"
}
```

### 3.2 本地存储键：`ka_logs` (打卡记录)
用于记录每日数据。
```json
{
  "date": "2023-10-27",      // string, 格式化日期作为索引
  "waterCount": 3,           // number, 已喝水杯数
  "movementDone": true,      // boolean, 今日是否已做运动(或者记录次数)
  "lastUpdate": "Timestamp"
}
```

---

## 4. 页面功能逻辑 (Page Logic)

### 🟢 页面 1：首页 (pages/index)
**功能：** 展示进度，执行打卡。

1.  **初始化 (onLoad/onShow)**:
    *   从本地存储读取 `ka_logs`，按今日日期过滤数据。
    *   如果今日无记录，初始化 `waterCount = 0`。
    *   渲染 UI：
        *   **中央**：圆形进度条 (Canvas 或 CSS 实现)，显示 `waterCount / settings`。
        *   **文案**：显示"今日已补水 X 杯"。
2.  **喝水打卡 (Action)**:
    *   点击"☕ 喝一杯"按钮。
    *   前端 UI 立即 `waterCount + 1` (乐观更新)。
    *   调用工具函数 `Storage.updateLog` 保存到本地存储。
    *   **反馈**：弹出轻提示 `wx.showToast({title: 'HP +1', icon: 'success'})`。
3.  **运动打卡 (Action)**:
    *   点击"🧘‍♂️ 提肛/走走"按钮。
    *   弹出一个覆盖层 (Overlay)，显示 60秒倒计时动画（简单的 CSS 动画，比如呼吸圈）。
    *   倒计时结束，播放提示音，toast 提示"底盘加固成功！"并保存到本地存储。

### ⚙️ 页面 2：设置页 (pages/settings)
**功能：** 登录、设置提醒。

1.  **微信一键登录 (Login)**:
    *   **组件**：使用 `<button open-type="chooseAvatar">` 获取头像，`<input type="nickname">` 获取昵称。
    *   **逻辑**：
        *   获取到资料后，调用 `Storage.saveUser` 保存用户信息到本地存储 `ka_user`。
        *   登录成功后，隐藏登录按钮，显示用户头像和昵称。
2.  **提醒设置 (Reminders)**:
    *   **开关**：`<switch>` 组件，绑定 `settings.remindSwitch`。
    *   **时间段**：使用 `<picker mode="time">` 选择"开始时间"和"结束时间"。
    *   **保存逻辑**：值改变时，自动调用 `Storage.updateSettings` 保存到本地存储。
3.  **订阅消息权限 (关键)**:
    *   在打开"提醒开关"时，**必须**触发 `wx.requestSubscribeMessage`。
    *   需要去微信后台申请一个"长期订阅"或"一次性订阅"的模板 ID (Template ID)。
    *   **注意**：个人开发者小程序通常只能用"一次性订阅"，意味着用户每点一次开关，只能发一次通知。如果是企业主体，可尝试长期。或者使用"日历事件"接口 `wx.addPhoneCalendar` 作为替代方案（推荐，无需后端）。

---

## 5. 本地存储工具函数 (未来可扩展为云开发)

### 💾 工具函数 A: `Storage.updateLog` (核心数据更新)
*   **存储位置**：本地存储键 `ka_logs`
*   **逻辑**：
    *   读取本地存储中的 logs 数组
    *   查找今日记录，如果存在则更新，不存在则创建
    *   写回本地存储
*   **代码示例**：
    ```javascript
    const logs = wx.getStorageSync('ka_logs') || []
    const today = new Date().toISOString().split('T')[0]
    const todayLog = logs.find(log => log.date === today)

    if (todayLog) {
      if (type === 'water') todayLog.waterCount++
      if (type === 'exercise') todayLog.movementDone = true
      todayLog.lastUpdate = new Date().getTime()
    } else {
      logs.push({
        date: today,
        waterCount: type === 'water' ? 1 : 0,
        movementDone: type === 'exercise',
        lastUpdate: new Date().getTime()
      })
    }
    wx.setStorageSync('ka_logs', logs)
    ```

### 📅 未来可扩展：`sendReminders` (云函数定时任务)
*   **配置**：在 `config.json` 中配置 `triggers` (Cron 表达式)。
*   **频率**：`0 0 10,14,16 * * * *` (每天10点, 14点, 16点触发)。
*   **逻辑**：
    1.  查询云端数据库用户集合。
    2.  循环调用 `cloud.openapi.subscribeMessage.send`。
    3.  *注*：V1.0 演示版本使用 App 内提醒或日历提醒，无需云函数。

---

## 6. Opencode 开发步骤指引 (Step-by-Step)

如果你使用 AI 辅助编程，请按此顺序下指令：

1.  **搭建骨架**：
    > "初始化一个微信小程序项目，创建 pages/index、pages/settings 和 pages/stats 三个页面，以及 utils 工具类目录。"
2.  **UI 实现**：
    > "在 index 页面实现一个环形进度条，配色使用 #88C0D0，中间显示数字。底部放置两个大圆角按钮，分别叫'喝水'和'提肛'。"
3.  **登录逻辑**：
    > "在 settings 页面实现微信头像和昵称填写功能，并将用户信息保存到本地存储 ka_user。"
4.  **业务逻辑**：
    > "实现 index 页面的喝水按钮逻辑：点击后数字加1，并将今日数据保存到本地存储 ka_logs 中，按日期索引。"
5.  **消息推送 (高级)**：
    > "实现本地提醒逻辑：在 App 启动时检查上次运动时间，超过设定间隔则显示提醒弹窗。"

---

### 💡 提醒功能说明 (演示版本)
由于微信对**"主动发消息给用户"**限制非常严格：
1.  **服务通知**：需要用户手动点击"允许接收订阅消息"。
2.  **演示方案 (推荐)**：V1.0 版本使用 **App 内提醒**（用户打开小程序时检测时间弹窗）或 **日历提醒** (`wx.addPhoneCalendar`)，无需服务器配置。
    *   *日历提醒逻辑*：用户在设置里点击"一键添加今日提醒"，App 调用接口直接往用户手机日历里写入几个闹钟（如 10:00, 14:00, 16:00），这个效果比微信服务通知更强力且不需要服务器轮询。
    *   *注：此方案无需后端支持，适合演示版本。*
